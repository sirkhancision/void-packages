# Template file for 'HeroicGamesLauncher'
pkgname=HeroicGamesLauncher
version=2.8.0
revision=1
archs="x86_64*"
_electron_version=24
hostmakedepends="electron${_electron_version} jq nodejs python3 yarn"
depends="electron${_electron_version} legendary heroic-gogdl"
checkdepends="tar xz"
short_desc="Open source launcher for GOG and Epic Games"
maintainer="sirkhancision <jsantiago12tone@gmail.com>"
license="GPL-3.0-or-later"
homepage="https://github.com/Heroic-Games-Launcher/HeroicGamesLauncher"
distfiles="https://github.com/Heroic-Games-Launcher/HeroicGamesLauncher/archive/v${version}.tar.gz"
checksum=59f068d6ba7e6c9c5d3c08f06b4cee23f07452777b9edb8baa61895fa9f40320
nopie_files="/usr/lib/HeroicGamesLauncher/resources/app.asar.unpacked/build/bin/linux/gogdl
/usr/lib/HeroicGamesLauncher/resources/app.asar.unpacked/build/bin/linux/legendary"

pre_build() {
	jq 'del(.scripts.prepare)' package.json >tmp.json
	mv {tmp,package}.json
}

do_build() {
	export ELECTRON_SKIP_BINARY_DOWNLOAD=1
	export PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD=1

	electronDist="/usr/lib/electron${_electron_version}"
	electronVer="$(sed s/^v// $electronDist/version)"

	yarn install
	yarn dist:linux --dir -c.electronDist="$electronDist" -c.electronVersion="$electronVer"
}

do_install() {
	heroic_name="com.heroicgameslauncher.hgl"

	vmkdir usr/lib/HeroicGamesLauncher/resources

	vcopy dist/linux-unpacked/resources/app.asar usr/lib/HeroicGamesLauncher/resources
	vcopy dist/linux-unpacked/resources/app.asar.unpacked usr/lib/HeroicGamesLauncher/resources
	vcopy build /usr/lib/HeroicGamesLauncher/resources/app.asar.unpacked
	rm -rf "${DESTDIR}/usr/lib/HeroicGamesLauncher/resources/app.asar.unpacked/build/bin/{linux/{gogdl,legendary},darwin,win32}"
	ln -sf "${DESTDIR}/usr/bin/{gogdl,legendary}" "${DESTDIR}/usr/lib/HeroicGamesLauncher/resources/app.asar.unpacked/build/bin/linux"
	ln -sf build "${DESTDIR}/usr/lib/HeroicGamesLauncher/resources/app.asar.unpacked/public"

	vinstall flatpak/$heroic_name.desktop 644 usr/share/applications
	vinstall build/icon.png 644 usr/share/icons/hicolor/512x512/apps/$heroic_name.png
	vinstall flatpak/$heroic_name.png 644 usr/share/icons/hicolor/128x128/apps

	vbin "${FILESDIR}/heroic-run"
	vsed -i "${DESTDIR}/usr/bin/heroic-run" -e "s/@@VERSION@@/$_electron_version/"
}
